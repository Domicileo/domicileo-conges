<!DOCTYPE html>
<!-- Domicileo Services – Gestion des congés payés (v25-stable-fix) -->
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Domicileo – Gestion des congés payés</title>

<!-- SheetJS (pour Import Excel / CSV) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#0066cc;--secondary:#f3f6fb;--danger:#e53935;
  --warning:#ffb300;--success:#4caf50;--text:#333;--bg:#fff;
  --radius:6px;--gap:.5rem;--absent-day:#90caf9;--holiday-day:var(--warning);
  --unpaid-day:#ffcc80
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,Arial,sans-serif;background:var(--secondary);color:var(--text)}
header{background:var(--primary);color:#fff;padding:1rem;text-align:center}
.container{max-width:1200px;margin:0 auto;padding:1rem}
.table-responsive{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-bottom:1rem}
th,td{padding:.4rem .6rem;border:1px solid #ccc;text-align:center;font-size:.9rem}
th{background:#eee;font-weight:600}
.row-alert{background:#fdecea}
.cell-has-days{background:var(--success);color:#fff}
.cell-unpaid{background:var(--warning);color:#000}
button,select{padding:.4rem .8rem;border:1px solid #ccc;border-radius:var(--radius);font:inherit}
button{cursor:pointer;border:none}
button.primary{background:var(--primary);color:#fff}
button.secondary{background:#ccc}
button.danger{background:var(--danger);color:#fff}
.no-print button{margin-right:var(--gap);margin-bottom:var(--gap)}
.calendar th.month{min-width:90px;cursor:pointer}
.calendar th.month:hover{background:#d0d7e4}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--bg);padding:1rem;border-radius:var(--radius);max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.modal-content.large{max-width:95%;width:95%}
.month-table thead th.day{width:32px}
.absent-day{background:var(--absent-day)}
.absent-holiday{background:var(--holiday-day)}
.unpaid-day{background:var(--unpaid-day)}
.wheel select{appearance:none;width:5.2rem;margin-right:.3rem;text-align:center}
@media print{header,.no-print,.modal{display:none!important}body{background:#fff}}
</style>
</head>

<body>
<header><h1>Domicileo – Gestion des congés payés</h1></header>

<div class="container">
  <div class="no-print" style="margin-bottom:var(--gap);display:flex;flex-wrap:wrap;align-items:center;gap:var(--gap)">
    <label for="yearSelect"><strong>Période&nbsp;:</strong></label>
    <select id="yearSelect"></select>
    <button id="addEmployeeBtn" class="primary">Ajouter salarié</button>
    <button id="exportCsvBtn" class="secondary">Export CSV</button>
    <button id="exportJsonBtn" class="secondary">Export JSON</button>
    <input type="file" id="importJsonInput" accept="application/json" hidden>
    <button id="importJsonBtn" class="secondary">Import JSON</button>
    <input type="file" id="importExcelInput" accept=".xlsx,.csv" hidden>
    <button id="importExcelBtn" class="secondary">Import Excel/CSV</button>
    <button id="printBtn" class="secondary">Imprimer / PDF</button>
  </div>

  <div class="table-responsive">
    <table id="employeeTable">
      <thead>
        <tr><th>Salarié·e</th><th>Acquis</th><th>Pris</th><th>Restant</th><th class="no-print">Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="calendar table-responsive">
    <table id="calendarTable"><thead></thead><tbody></tbody></table>
  </div>
</div>

<!-- Modale GÉRER -->
<div id="manageModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h2 id="modalTitle"></h2>
    <div class="wheel"><label>Départ<br><select id="startDay"></select><select id="startMonth"></select><select id="startYear"></select></label></div>
    <div class="wheel" style="margin-top:.5rem"><label>Retour<br><select id="endDay"></select><select id="endMonth"></select><select id="endYear"></select></label></div>
    <label style="display:block;margin:0.8rem 0"><input type="checkbox" id="unpaidCheckbox"> Sans solde</label>
    <button id="addPeriodBtn" class="primary" style="margin:1rem 0">Ajouter la période</button>
    <h3>Jours posés</h3><ul id="daysList"></ul>
    <div style="text-align:right"><button id="closeModalBtn" class="secondary">Fermer</button></div>
  </div>
</div>

<!-- Modale vue mensuelle -->
<div id="monthModal" class="modal" aria-hidden="true">
  <div class="modal-content large">
    <h2 id="monthModalTitle"></h2>
    <div class="table-responsive"><table id="monthTable" class="month-table"><thead></thead><tbody></tbody></table></div>
    <div style="text-align:right"><button id="closeMonthBtn" class="secondary">Fermer</button></div>
  </div>
</div>

<script>
/* ---------- Stockage ---------- */
const LS_KEY='domicileo_conges_data',SCHEMA_VERSION=1,DEFAULT_PERIOD='2025-2026';
const defaultStore={schemaVersion:SCHEMA_VERSION,employees:[],records:{}};
function loadStore(){try{const r=localStorage.getItem(LS_KEY);if(!r)throw 0;const d=JSON.parse(r);return d.schemaVersion===SCHEMA_VERSION?d:defaultStore;}catch{return structuredClone(defaultStore);}}
function saveStore(){localStorage.setItem(LS_KEY,JSON.stringify(store));}
let store=loadStore();

/* ---------- RÉFÉRENCES DOM (ré-ajout) ---------- */
const employeeTBody   = document.querySelector('#employeeTable tbody');
const calendarThead   = document.querySelector('#calendarTable thead');
const calendarTBody   = document.querySelector('#calendarTable tbody');
const monthTable      = document.getElementById('monthTable');
const monthModalTitle = document.getElementById('monthModalTitle');
const modalTitle      = document.getElementById('modalTitle');

/* ---------- Helpers dates ---------- */
const TODAY=new Date(),periodStartYear=p=>+p.split('-')[0];
const diffMonths=(l,e)=>l.getMonth()-e.getMonth()+12*(l.getFullYear()-e.getFullYear());
const daysInMonth=(y,m)=>new Date(y,m+1,0).getDate();
const workDays=(s,e)=>{const a=[];for(let d=new Date(s);d<=e;d.setDate(d.getDate()+1))if(d.getDay()!==0)a.push(d.toISOString().slice(0,10));return a;}
const HCACHE={},easter=y=>{const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),n=h+l-7*m+114;return new Date(y,Math.floor(n/31)-1,n%31+1);};
const holidays=y=>{if(HCACHE[y])return HCACHE[y];const E=easter(y),add=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;},fmt=d=>d.toISOString().slice(0,10);const set=new Set([`${y}-01-01`,`${y}-05-01`,`${y}-05-08`,`${y}-07-14`,`${y}-08-15`,`${y}-11-01`,`${y}-11-11`,`${y}-12-25`,fmt(add(E,1)),fmt(add(E,39)),fmt(add(E,50))]);HCACHE[y]=set;return set;}
const isHoliday=d=>holidays(new Date(d).getFullYear()).has(d);

/* ---------- Accès store ---------- */
const ensureRec=(p,id)=>{store.records[p]=store.records[p]||{};store.records[p][id]=store.records[p][id]||{days:[],unpaid:[]};}
const acquired=(id,p)=>{const o=store.records?.[p]?.[id]?.acqOverride;if(typeof o==='number')return o;
  const sy=periodStartYear(p),ey=sy+1,start=new Date(`${sy}-06-01`),end=new Date(`${ey}-05-31`),last=TODAY<end?TODAY:end,m=Math.min(12,diffMonths(last,start)+1);return +(m*2.5).toFixed(1);}
const taken=(id,p)=>(store.records?.[p]?.[id]?.days||[]).filter(d=>!isHoliday(d)).length;
const activeEmp=p=>{const sy=periodStartYear(p);return(store.employees||[]).filter(e=>(e.joined??0)<=sy&&(!e.inactiveFrom||sy<e.inactiveFrom));}

/* ---------- Sélecteur périodes ---------- */
(function(){
  for(let y=2025;y<=2075;y++){const o=document.createElement('option');o.value=`${y}-${y+1}`;o.textContent=o.value;yearSelect.appendChild(o);}
  yearSelect.value=DEFAULT_PERIOD;
})();

/* ---------- Table employés ---------- */
function renderEmployees(){
  const p=yearSelect.value;employeeTBody.innerHTML='';
  activeEmp(p).sort((a,b)=>a.name.localeCompare(b.name)).forEach(emp=>{
    ensureRec(p,emp.id);
    const rec=store.records[p][emp.id],acq=acquired(emp.id,p),tk=taken(emp.id,p),rest=+(acq-tk).toFixed(1);
    const tr=document.createElement('tr');if(rest<0)tr.classList.add('row-alert');
    tr.innerHTML=`<td>${emp.name}</td><td>${acq}</td><td>${tk}</td><td>${rest}</td>
      <td class="no-print">
        <button class="primary manageBtn" data-id="${emp.id}">Gérer</button>
        <button class="secondary editAcqBtn" data-id="${emp.id}">Acquis</button>
        <button class="danger delEmpBtn" data-id="${emp.id}">Suppr</button>
      </td>`;
    employeeTBody.appendChild(tr);
  });
  document.querySelectorAll('.manageBtn').forEach(b=>b.onclick=()=>openModal(b.dataset.id));
  document.querySelectorAll('.editAcqBtn').forEach(b=>b.onclick=()=>editAcq(b.dataset.id));
  document.querySelectorAll('.delEmpBtn').forEach(b=>b.onclick=()=>removeEmp(b.dataset.id));
}

/* ---------- Calendrier ---------- */
const idxToMonth=i=>(i+5)%12;
function renderCalendar(){
  const p=yearSelect.value,months=['Juin','Juil','Août','Sep','Oct','Nov','Déc','Jan','Fév','Mar','Avr','Mai'];
  calendarThead.innerHTML='<tr><th>Salarié·e</th>'+months.map(m=>`<th class="month">${m}</th>`).join('')+'</tr>';
  calendarTBody.innerHTML='';
  activeEmp(p).forEach(emp=>{
    ensureRec(p,emp.id);const rec=store.records[p][emp.id];
    const tr=document.createElement('tr');tr.innerHTML=`<td>${emp.name}</td>`;
    months.forEach((_,i)=>{const m=idxToMonth(i),paid=rec.days.filter(d=>new Date(d).getMonth()===m&&!isHoliday(d)),unpaid=rec.unpaid.filter(d=>new Date(d).getMonth()===m);
      const td=document.createElement('td');
      if(paid.length){td.textContent=paid.length;td.classList.add('cell-has-days');td.title=[...paid,...unpaid].join(', ');}
      else if(unpaid.length){td.classList.add('cell-unpaid');td.title=unpaid.join(', ');}
      tr.appendChild(td);
    });
    calendarTBody.appendChild(tr);
  });
  document.querySelectorAll('#calendarTable thead th.month').forEach((th,i)=>th.onclick=()=>openMonth(i));
}

/* ---------- Modale mensuelle ---------- */
function openMonth(idx){
  const p=yearSelect.value,sy=periodStartYear(p),m=idxToMonth(idx),yr=m>=5?sy:sy+1,tot=daysInMonth(yr,m);
  const names=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
  monthModalTitle.textContent=`${names[m]} ${yr}`;
  monthTable.tHead.innerHTML='<tr><th>Salarié·e</th>'+[...Array(tot)].map((_,d)=>`<th class="day">${d+1}</th>`).join('')+'</tr>';
  monthTable.tBodies[0].innerHTML='';
  activeEmp(p).forEach(emp=>{
    const rec=store.records[p][emp.id],paid=new Set(rec.days.filter(d=>{const dt=new Date(d);return dt.getFullYear()===yr&&dt.getMonth()===m;})),
          unpaid=new Set(rec.unpaid.filter(d=>{const dt=new Date(d);return dt.getFullYear()===yr&&dt.getMonth()===m;}));
    let row=`<td>${emp.name}</td>`;
    for(let d=1;d<=tot;d++){
      const ds=`${yr}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      if(paid.has(ds))row+=`<td class="${isHoliday(ds)?'absent-holiday':'absent-day'}" title="Payé">C</td>`;
      else if(unpaid.has(ds))row+=`<td class="unpaid-day" title="Sans solde">S</td>`;
      else row+='<td></td>';
    }
    const tr=document.createElement('tr');tr.innerHTML=row;monthTable.tBodies[0].appendChild(tr);
  });
  monthModal.classList.add('show');
}
closeMonthBtn.onclick=()=>monthModal.classList.remove('show');

/* ---------- Modale Gérer ---------- */
let curId=null;
function openModal(id){
  curId=id;modalTitle.textContent=store.employees.find(e=>e.id===id)?.name||'';
  fillDateWheels();unpaidCheckbox.checked=false;refreshList();
  manageModal.classList.add('show');
}
closeModalBtn.onclick=()=>manageModal.classList.remove('show');

const dayOpt=[...Array(31)].map((_,i)=>String(i+1).padStart(2,'0')),
      monthOpt=[...Array(12)].map((_,i)=>String(i+1).padStart(2,'0'));
function fill(sel,vals){sel.innerHTML=vals.map(v=>`<option>${v}</option>`).join('');}
function fillDateWheels(){const sy=periodStartYear(yearSelect.value),yrs=[sy,sy+1];['start','end'].forEach(p=>{fill(window[p+'Day'],dayOpt);fill(window[p+'Month'],monthOpt);fill(window[p+'Year'],yrs);});}
const readDate=p=>`${window[p+'Year'].value}-${window[p+'Month'].value}-${window[p+'Day'].value}`;

function refreshList(){
  const p=yearSelect.value,rec=store.records[p][curId];daysList.innerHTML='';
  [...rec.days.map(d=>({d,t:'payé'})),...rec.unpaid.map(d=>({d,t:'sans solde'}))]
    ..sort((a,b)=>a.d.localeCompare(b.d))
    .forEach(({d,t})=>{
      const li=document.createElement('li');li.textContent=`${d} (${t}${isHoliday(d)?', férié':''})`;
      const b=document.createElement('button');b.textContent='Suppr';b.className='danger';
      b.onclick=()=>{rec.days=rec.days.filter(x=>x!==d);rec.unpaid=rec.unpaid.filter(x=>x!==d);saveStore();refreshList();renderEmployees();renderCalendar();}
      li.appendChild(b);daysList.appendChild(li);
    });
}

addPeriodBtn.onclick=()=>{
  const s=readDate('start'),e=readDate('end');
  if(!s||!e)return alert('Choisir les dates');if(new Date(e)<new Date(s))return alert('Retour avant départ');
  const p=yearSelect.value,days=workDays(new Date(s),new Date(e)),
        valid=days.filter(d=>{const sy=periodStartYear(p),start=new Date(`${sy}-06-01`),end=new Date(`${sy+1}-05-31`);return new Date(d)>=start&&new Date(d)<=end;});
  if(!valid.length)return alert('Aucun jour valide');
  const rec=store.records[p][curId];(unpaidCheckbox.checked?rec.unpaid:rec.days).push(...valid);
  saveStore();refreshList();renderEmployees();renderCalendar();
};

/* ---------- Actions ligne ---------- */
function editAcq(id){
  const p=yearSelect.value,val=prompt(`Jours acquis pour ${store.employees.find(e=>e.id===id)?.name||''} (${p}) :`,acquired(id,p));
  if(val===null)return;const n=parseFloat(val.replace(',','.'));if(isNaN(n)||n<0)return alert('Invalide');
  ensureRec(p,id);store.records[p][id].acqOverride=n;saveStore();renderEmployees();
}
function removeEmp(id){
  if(!confirm('Supprimer à partir de cette période ?'))return;
  const y=periodStartYear(yearSelect.value);const e=store.employees.find(e=>e.id===id);if(e)e.inactiveFrom=y;
  for(const p in store.records)if(periodStartYear(p)>=y)delete store.records[p][id];
  saveStore();renderEmployees();renderCalendar();
}

/* ---------- Boutons top ---------- */
addEmployeeBtn.onclick=()=>{
  const n=prompt('Nom du / de la salarié·e :');if(!n)return;
  store.employees.push({id:'e'+Date.now(),name:n.trim(),joined:periodStartYear(yearSelect.value)});
  saveStore();renderEmployees();renderCalendar();
};
exportJsonBtn.onclick=()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(store)],{type:'application/json'}));a.download='conges_backup.json';a.click();}
importJsonBtn.onclick=()=>importJsonInput.click();
importJsonInput.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{localStorage.setItem(LS_KEY,ev.target.result);location.reload();}catch{alert('JSON invalide');}};r.readAsText(f,'utf-8');}
exportCsvBtn.onclick=()=>{
  const p=yearSelect.value;let csv='Employee;Acquis;Pris;Restant;Payés;SansSolde\n';
  activeEmp(p).forEach(emp=>{ensureRec(p,emp.id);const rec=store.records[p][emp.id];
    csv+=`${emp.name};${acquired(emp.id,p)};${taken(emp.id,p)};${acquired(emp.id,p)-taken(emp.id,p)};"${rec.days.join(' ')}";"${rec.unpaid.join(' ')}"\n`;});
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=`conges_${p}.csv`;a.click();
};
printBtn.onclick=()=>window.print();

/* ---------- Import Excel / CSV ---------- */
importExcelBtn.onclick=()=>importExcelInput.click();
importExcelInput.onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]],rows=XLSX.utils.sheet_to_json(ws,{header:1});if(!rows.length)return alert('Vide');
      const head=rows[0].map(h=>h.toString().toLowerCase()),idx={emp:head.findIndex(h=>/intervenant|employee|salari/i.test(h)),deb:1,fin:2,type:3};
      if(idx.emp===-1)return alert('Colonne Intervenant manquante');
      const p=yearSelect.value;
      rows.slice(1).forEach(r=>{
        const name=r[idx.emp];if(!name)return;
        let emp=store.employees.find(e=>e.name.trim()===name.trim());
        if(!emp){emp={id:'e'+Date.now()+Math.random(),name:name.trim(),joined:periodStartYear(p)};store.employees.push(emp);}
        ensureRec(p,emp.id);
        const days=workDays(new Date(r[idx.deb]),new Date(r[idx.fin]));
        const tgt=(r[idx.type]||'').toString().toLowerCase().includes('sans')?'unpaid':'days';
        store.records[p][emp.id][tgt].push(...days.filter(d=>{const sy=periodStartYear(p),start=new Date(`${sy}-06-01`),end=new Date(`${sy+1}-05-31`);return new Date(d)>=start&&new Date(d)<=end;}));
      });
      saveStore();renderEmployees();renderCalendar();alert('Import terminé');
    }catch(err){console.error(err);alert('Erreur import');}
  };r.readAsArrayBuffer(f);
};

/* ---------- Init ---------- */
if(!store.employees.length)store.employees=[{id:'e1',name:'Alice Dupont',joined:2025}];
renderEmployees();renderCalendar();
yearSelect.onchange=()=>{renderEmployees();renderCalendar();}
</script>
</body>
</html>
