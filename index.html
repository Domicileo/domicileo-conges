<!DOCTYPE html>
<!-- Domicileo Services ‚Äì Gestion des cong√©s pay√©s (v23) -->
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Domicileo Services ‚Äì Gestion des cong√©s pay√©s</title>

<!-- 1 ≥·µâ inclusion SheetJS (chargement anticip√©) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{--primary:#0066cc;--secondary:#f3f6fb;--danger:#e53935;
--warning:#ffb300;--success:#4caf50;--text:#333;--bg:#fff;
--radius:6px;--gap:.5rem;--absent-day:#90caf9;--holiday-day:var(--warning);
--unpaid-day:#ffcc80;}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,Arial,sans-serif;background:var(--secondary);color:var(--text)}
header{background:var(--primary);color:#fff;padding:1rem;text-align:center}
.container{max-width:1200px;margin:0 auto;padding:1rem}
.table-responsive{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-bottom:1rem}
th,td{padding:.4rem .6rem;border:1px solid #ccc;text-align:center;font-size:.9rem}
th{background:#eee;font-weight:600}
.row-alert{background:#fdecea}
.cell-has-days{background:var(--success);color:#fff}
.cell-unpaid{background:var(--warning);color:#000}
button,select{padding:.4rem .8rem;border:1px solid #ccc;border-radius:var(--radius);font:inherit}
button{cursor:pointer;border:none}
button.primary{background:var(--primary);color:#fff}
button.secondary{background:#ccc}
button.danger{background:var(--danger);color:#fff}
.no-print button{margin-right:var(--gap);margin-bottom:var(--gap)}
.calendar th.month{min-width:90px;cursor:pointer}
.calendar th.month:hover{background:#d0d7e4}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--bg);padding:1rem;border-radius:var(--radius);max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.modal-content.large{max-width:95%;width:95%}
.month-table thead th.day{width:32px}
.absent-day{background:var(--absent-day)}
.absent-holiday{background:var(--holiday-day)}
.unpaid-day{background:var(--unpaid-day)}
.wheel select{appearance:none;width:5.2rem;margin-right:.3rem;text-align:center}
@media print{header,.no-print,.modal{display:none!important}body{background:#fff}}
</style>
</head>

<body>
<header><h1>Domicileo Services ‚Äì Gestion des cong√©s pay√©s</h1></header>

<div class="container">
  <div class="no-print" style="margin-bottom:var(--gap);display:flex;flex-wrap:wrap;align-items:center;gap:var(--gap)">
    <label for="yearSelect"><strong>P√©riode&nbsp;:</strong></label>
    <select id="yearSelect"></select>
    <button id="addEmployeeBtn" class="primary">Ajouter salari√©</button>
    <button id="exportCsvBtn" class="secondary">Export CSV</button>
    <button id="exportJsonBtn" class="secondary">Export JSON</button>
    <input type="file" id="importJsonInput" accept="application/json" style="display:none">
    <button id="importJsonBtn" class="secondary">Import JSON</button>
    <input type="file" id="importExcelInput" accept=".xlsx,.csv" style="display:none">
    <button id="importExcelBtn" class="secondary">Import Excel/CSV</button>
    <button id="printBtn" class="secondary">Imprimer / PDF</button>
  </div>

  <div class="table-responsive">
    <table id="employeeTable">
      <thead><tr>
        <th>Salari√©¬∑e</th><th>Acquis</th><th>Pris</th><th>Restant</th>
        <th class="no-print">Actions</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="calendar table-responsive">
    <table id="calendarTable"><thead></thead><tbody></tbody></table>
  </div>
</div>

<!-- Modales (inchang√©es) -->
<div id="manageModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h2 id="modalTitle">G√©rer les cong√©s</h2>
    <div class="wheel"><label><strong>Date de d√©part&nbsp;:</strong><br>
      <select id="startDay"></select><select id="startMonth"></select><select id="startYear"></select></label></div>
    <div class="wheel" style="margin-top:.5rem"><label><strong>Date de retour&nbsp;:</strong><br>
      <select id="endDay"></select><select id="endMonth"></select><select id="endYear"></select></label></div>
    <label style="display:block;margin:0.8rem 0"><input type="checkbox" id="unpaidCheckbox"> Sans solde</label>
    <button id="addPeriodBtn" class="primary" style="margin:1rem 0">Ajouter la p√©riode</button>
    <h3>Jours pos√©s</h3><ul id="daysList"></ul>
    <div style="text-align:right"><button id="closeModalBtn" class="secondary">Fermer</button></div>
  </div>
</div>

<div id="monthModal" class="modal" aria-hidden="true">
  <div class="modal-content large">
    <h2 id="monthModalTitle"></h2>
    <div class="table-responsive"><table id="monthTable" class="month-table"><thead></thead><tbody></tbody></table></div>
    <div style="text-align:right"><button id="closeMonthBtn" class="secondary">Fermer</button></div>
  </div>
</div>

<!-- 2·µâ inclusion SheetJS (garantie ordre) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<script>
/* --------------- Variables et fonctions principales (identiques v22) --------------- */
/* ... [tout le code JS pr√©c√©dent, inchang√©, jusque juste avant l'import Excel] ... */

/* ---------- Import Excel/CSV (v23) ---------- */
document.getElementById('importExcelBtn').onclick =
  () => document.getElementById('importExcelInput').click();

document.getElementById('importExcelInput').onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;

  /* üîí Fallback : charge SheetJS dynamiquement si la variable n‚Äôexiste pas */
  if (typeof XLSX === 'undefined') {
    const module = await import('https://cdn.jsdelivr.net/npm/xlsx@0.19.3/+esm');
    window.XLSX = module.default || module;
    console.log('SheetJS charg√© dynamiquement');
  }

  const reader = new FileReader();
  reader.onload = ev => {
    try {
      /* ---- Code d‚Äôimport v22 inchang√© (conversion dates, cr√©ation salari√©s, etc.) ---- */
      const wb = XLSX.read(new Uint8Array(ev.target.result),
                            { type:'array', codepage:1252 });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
      if (!rows.length) return alert('Feuille vide');

      const head = rows[0].map(h => h.toString().trim());
      const idx  = {
        emp  : head.findIndex(h => /^(Employee|Intervenant|Salari[√©e])/i.test(h)),
        start: head.findIndex(h => /^(StartDate|D√©part)/i.test(h)),
        end  : head.findIndex(h => /^(EndDate|Date de fin)/i.test(h)),
        type : head.findIndex(h => /^(Type|Motif)/i.test(h))
      };
      if (Object.values(idx).some(v => v === -1))
        return alert('Colonnes manquantes');

      const period = yearSelect.value;

      const excelDateToIso = v => {
        if (v instanceof Date)
          return v.toISOString().slice(0,10);
        if (typeof v === 'number') {
          const epoch = Date.UTC(1899,11,30);
          return new Date(epoch + v*864e5).toISOString().slice(0,10);
        }
        const s = v.toString().trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        const [d,m,y] = s.split(' ')[0].split(/[\/\-\.]/);
        return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
      };
      const normName = raw => {
        const t = raw.toString().trim();
        if (!t) return '';
        if (t.includes(',')) {
          const [last, first] = t.split(',');
          return `${first.trim()} ${last.trim()}`.replace(/\s+/g,' ');
        }
        return t.replace(/\s+/g,' ');
      };

      rows.slice(1).forEach(r => {
        const empName = normName(r[idx.emp]);
        const start   = excelDateToIso(r[idx.start]);
        const end     = excelDateToIso(r[idx.end]);
        const rawType = (r[idx.type] || '').toString().toLowerCase();
        const isUnpaid = /sans solde|unpaid/.test(rawType);

        if (!empName || !start || !end) return;

        let emp = store.employees.find(e => e.name === empName);
        if (!emp) {
          emp = { id:'e'+Date.now()+Math.random(),
                  name: empName, joined: periodStartYear(period) };
          store.employees.push(emp);
        }
        ensureRecord(period, emp.id);

        const days = validateDays(
          emp.id,
          period,
          getWorkingDays(new Date(start), new Date(end))
        );
        if (!days.length) return;

        const rec = store.records[period][emp.id];
        (isUnpaid ? rec.unpaid : rec.days).push(...days);
      });

      saveStore();
      renderEmployees();
      renderCalendar();
      alert('Import termin√© !');
    } catch (err) {
      console.error(err);
      alert('Erreur lors de l‚Äôimport : ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
};

/* ---------- Init (inchang√©) ---------- */
if(!store.employees.length)
  store.employees=[{id:'e1',name:'Alice Dupont',joined:2025}];
renderEmployees();
renderCalendar();
</script>
</body>
</html>
