<!DOCTYPE html>
<!-- Domicileo Services – Gestion des congés payés (v21) -->
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Domicileo Services – Gestion des congés payés</title>

<!-- SheetJS pour l’import Excel/CSV -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#0066cc;--secondary:#f3f6fb;--danger:#e53935;
  --warning:#ffb300;--success:#4caf50;--text:#333;--bg:#fff;
  --radius:6px;--gap:.5rem;--absent-day:#90caf9;--holiday-day:var(--warning);
  --unpaid-day:#ffcc80;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,Arial,sans-serif;background:var(--secondary);color:var(--text)}
header{background:var(--primary);color:#fff;padding:1rem;text-align:center}
.container{max-width:1200px;margin:0 auto;padding:1rem}
.table-responsive{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-bottom:1rem}
th,td{padding:.4rem .6rem;border:1px solid #ccc;text-align:center;font-size:.9rem}
th{background:#eee;font-weight:600}
.row-alert{background:#fdecea}
.cell-has-days{background:var(--success);color:#fff}
.cell-unpaid{background:var(--warning);color:#000}
button,select{padding:.4rem .8rem;border:1px solid #ccc;border-radius:var(--radius);font:inherit}
button{cursor:pointer;border:none}
button.primary{background:var(--primary);color:#fff}
button.secondary{background:#ccc}
button.danger{background:var(--danger);color:#fff}
.no-print button{margin-right:var(--gap);margin-bottom:var(--gap)}
.calendar th.month{min-width:90px;cursor:pointer}
.calendar th.month:hover{background:#d0d7e4}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--bg);padding:1rem;border-radius:var(--radius);max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.modal-content.large{max-width:95%;width:95%}
.month-table thead th.day{width:32px}
.absent-day{background:var(--absent-day)}
.absent-holiday{background:var(--holiday-day)}
.unpaid-day{background:var(--unpaid-day)}
.wheel select{appearance:none;width:5.2rem;margin-right:.3rem;text-align:center}
@media print{header,.no-print,.modal{display:none!important}body{background:#fff}}
</style>
</head>

<body>
<header><h1>Domicileo Services – Gestion des congés payés</h1></header>

<div class="container">
  <div class="no-print" style="margin-bottom:var(--gap);display:flex;flex-wrap:wrap;align-items:center;gap:var(--gap)">
    <label for="yearSelect"><strong>Période&nbsp;:</strong></label>
    <select id="yearSelect"></select>
    <button id="addEmployeeBtn" class="primary">Ajouter salarié</button>
    <button id="exportCsvBtn" class="secondary">Export CSV</button>
    <button id="exportJsonBtn" class="secondary">Export JSON</button>
    <input type="file" id="importJsonInput" accept="application/json" style="display:none">
    <button id="importJsonBtn" class="secondary">Import JSON</button>
    <!-- Import Excel/CSV -->
    <input type="file" id="importExcelInput" accept=".xlsx,.csv" style="display:none">
    <button id="importExcelBtn" class="secondary">Import Excel/CSV</button>
    <button id="printBtn" class="secondary">Imprimer / PDF</button>
  </div>

  <div class="table-responsive">
    <table id="employeeTable">
      <thead><tr>
        <th>Salarié·e</th><th>Acquis</th><th>Pris</th><th>Restant</th>
        <th class="no-print">Actions</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="calendar table-responsive">
    <table id="calendarTable"><thead></thead><tbody></tbody></table>
  </div>
</div>

<!-- Modale congés individuels -->
<div id="manageModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h2 id="modalTitle">Gérer les congés</h2>

    <div class="wheel">
      <label><strong>Date de départ&nbsp;:</strong><br>
        <select id="startDay"></select>
        <select id="startMonth"></select>
        <select id="startYear"></select>
      </label>
    </div>

    <div class="wheel" style="margin-top:.5rem">
      <label><strong>Date de retour&nbsp;:</strong><br>
        <select id="endDay"></select>
        <select id="endMonth"></select>
        <select id="endYear"></select>
      </label>
    </div>

    <label style="display:block;margin:0.8rem 0">
      <input type="checkbox" id="unpaidCheckbox"> Sans solde
    </label>

    <button id="addPeriodBtn" class="primary" style="margin:1rem 0">Ajouter la période</button>
    <h3>Jours posés</h3><ul id="daysList"></ul>
    <div style="text-align:right"><button id="closeModalBtn" class="secondary">Fermer</button></div>
  </div>
</div>

<!-- Modale vue mensuelle -->
<div id="monthModal" class="modal" aria-hidden="true">
  <div class="modal-content large">
    <h2 id="monthModalTitle"></h2>
    <div class="table-responsive">
      <table id="monthTable" class="month-table"><thead></thead><tbody></tbody></table>
    </div>
    <div style="text-align:right"><button id="closeMonthBtn" class="secondary">Fermer</button></div>
  </div>
</div>

<script>
/* ---------- Stockage ---------- */
const LS_KEY = 'domicileo_conges_data';
const SCHEMA_VERSION = 1;
const DEFAULT_PERIOD  = '2025-2026';

const defaultStore = { schemaVersion: SCHEMA_VERSION, employees: [], records: {} };
function migrate(o) { o.schemaVersion = SCHEMA_VERSION; return o; }
function loadStore() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return { ...defaultStore };
    const data = JSON.parse(raw);
    return data.schemaVersion === SCHEMA_VERSION ? data : migrate(data);
  } catch { return { ...defaultStore }; }
}
function saveStore() { localStorage.setItem(LS_KEY, JSON.stringify(store)); }
let store = loadStore();

/* ---------- Utils ---------- */
const TODAY = new Date();
const periodStartYear = p => +p.split('-')[0];
const diffMonths = (l,e) => l.getMonth()-e.getMonth()+12*(l.getFullYear()-e.getFullYear());
const daysInMonth = (y,m) => new Date(y,m+1,0).getDate();
const getWorkingDays = (s,e) => { const o=[]; for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) if(d.getDay()!==0) o.push(d.toISOString().slice(0,10)); return o; };

/* Fériés France */
const HCACHE={};
const easter=y=>{const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),n=h+l-7*m+114;return new Date(y,Math.floor(n/31)-1,n%31+1);};
const holidaysFR=y=>{if(HCACHE[y])return HCACHE[y];const E=easter(y),add=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;},fmt=d=>d.toISOString().slice(0,10);const set=new Set([`${y}-01-01`,`${y}-05-01`,`${y}-05-08`,`${y}-07-14`,`${y}-08-15`,`${y}-11-01`,`${y}-11-11`,`${y}-12-25`,fmt(add(E,1)),fmt(add(E,39)),fmt(add(E,50))]);HCACHE[y]=set;return set;}
const isHoliday = d => holidaysFR(new Date(d).getFullYear()).has(d);

/* Droits */
const defaultAcq = p => {const sy=periodStartYear(p),ey=sy+1,start=new Date(`${sy}-06-01`),end=new Date(`${ey}-05-31`),last=TODAY<end?TODAY:end,m=Math.min(12,diffMonths(last,start)+1);return +(m*2.5).toFixed(1);};
const acquired = (id,p) => { const o=store.records?.[p]?.[id]?.acqOverride; return typeof o==='number'?o:defaultAcq(p); };
const taken    = (id,p) => (store.records?.[p]?.[id]?.days||[]).filter(d=>!isHoliday(d)).length;
const validateDays = (id,p,days)=>{
  const sy=periodStartYear(p),start=new Date(`${sy}-06-01`),end=new Date(`${sy+1}-05-31`),
        rec = store.records?.[p]?.[id] || {}, used=new Set([...(rec.days||[]),...(rec.unpaid||[])]);
  return days.filter(d=>{ const dt=new Date(d); return dt>=start&&dt<=end&&dt.getDay()!==0&&!used.has(d); });
};

/* ---------- DOM refs ---------- */
const yearSelect=document.getElementById('yearSelect'),
      employeeTBody=document.querySelector('#employeeTable tbody'),
      calendarThead=document.querySelector('#calendarTable thead'),
      calendarTBody=document.querySelector('#calendarTable tbody');

/* ---------- Périodes ---------- */
(()=>{for(let y=2025;y<=2075;y++){const o=document.createElement('option');o.value=`${y}-${y+1}`;o.textContent=o.value;yearSelect.appendChild(o);}yearSelect.value=DEFAULT_PERIOD;})();
yearSelect.onchange=()=>{renderEmployees();renderCalendar();};

/* ---------- Salariés helpers ---------- */
const activeEmployees=p=>{const sy=periodStartYear(p);return(store.employees||[]).filter(e=>(e.joined??0)<=sy&&(!e.inactiveFrom||sy<e.inactiveFrom));};
const employeeName=id=>store.employees.find(e=>e.id===id)?.name||'';
const ensureRecord=(p,id)=>{store.records[p]=store.records[p]||{};store.records[p][id]=store.records[p][id]||{days:[],unpaid:[]};};

/* ---------- Date wheels ---------- */
const dayOpts=[...Array(31)].map((_,i)=>(i+1).toString().padStart(2,'0')),monthOpts=[...Array(12)].map((_,i)=>(i+1).toString().padStart(2,'0'));
function fill(sel,vals){sel.innerHTML=vals.map(v=>`<option>${v}</option>`).join('');}
function initWheels(){const sy=periodStartYear(yearSelect.value),yrs=[sy,sy+1];['start','end'].forEach(p=>{fill(document.getElementById(p+'Day'),dayOpts);fill(document.getElementById(p+'Month'),monthOpts);fill(document.getElementById(p+'Year'),yrs);});}
const readDate=p=>`${document.getElementById(p+'Year').value}-${document.getElementById(p+'Month').value}-${document.getElementById(p+'Day').value}`;

/* ---------- Tableau synthèse ---------- */
function renderEmployees(){
  const per=yearSelect.value;
  employeeTBody.innerHTML='';
  activeEmployees(per).sort((a,b)=>a.name.localeCompare(b.name)).forEach(emp=>{
    ensureRecord(per,emp.id);const rec=store.records[per][emp.id],
          acq=acquired(emp.id,per),tk=taken(emp.id,per),rest=+(acq-tk).toFixed(1);
    const tr=document.createElement('tr');if(rest<0)tr.classList.add('row-alert');
    tr.innerHTML=`<td>${emp.name}</td><td>${acq}</td><td>${tk}</td><td>${rest}</td>
      <td class="no-print">
        <button class="primary manageBtn" data-id="${emp.id}">Gérer</button>
        <button class="secondary editAcqBtn" data-id="${emp.id}">Acquis</button>
        <button class="danger delEmpBtn" data-id="${emp.id}">Suppr</button>
      </td>`;
    employeeTBody.appendChild(tr);
  });
  document.querySelectorAll('.manageBtn').forEach(b=>b.onclick=()=>openModal(b.dataset.id));
  document.querySelectorAll('.editAcqBtn').forEach(b=>b.onclick=()=>editAcq(b.dataset.id));
  document.querySelectorAll('.delEmpBtn').forEach(b=>b.onclick=()=>delEmp(b.dataset.id));
}

/* ---------- Actions ligne ---------- */
function editAcq(id){const per=yearSelect.value,v=prompt(`Jours acquis pour ${employeeName(id)} (${per}) :`,acquired(id,per));if(v===null)return;const num=parseFloat(v.replace(',','.'));if(isNaN(num)||num<0)return alert('Valeur invalide');ensureRecord(per,id);store.records[per][id].acqOverride=num;saveStore();renderEmployees();}
function delEmp(id){if(!confirm('Supprimer à partir de cette période ?'))return;const startY=periodStartYear(yearSelect.value),e=store.employees.find(e=>e.id===id);if(e)e.inactiveFrom=startY;for(const p in store.records)if(periodStartYear(p)>=startY)delete store.records[p][id];saveStore();renderEmployees();renderCalendar();}

/* ---------- Calendrier ---------- */
const idxToMonth=i=>(i+5)%12;
function renderCalendar(){
  const per=yearSelect.value,months=['Juin','Juil','Août','Sep','Oct','Nov','Déc','Jan','Fév','Mar','Avr','Mai'];
  calendarThead.innerHTML='<tr><th>Salarié·e</th>'+months.map(m=>`<th class="month">${m}</th>`).join('')+'</tr>';
  calendarTBody.innerHTML='';
  activeEmployees(per).sort((a,b)=>a.name.localeCompare(b.name)).forEach(emp=>{
    ensureRecord(per,emp.id);const rec=store.records[per][emp.id],tr=document.createElement('tr');tr.innerHTML=`<td>${emp.name}</td>`;
    months.forEach((_,i)=>{const td=document.createElement('td');const m=idxToMonth(i),paid=rec.days.filter(d=>new Date(d).getMonth()===m&&!isHoliday(d)),unpaid=rec.unpaid.filter(d=>new Date(d).getMonth()===m);if(paid.length){td.textContent=paid.length;td.classList.add('cell-has-days');td.title=[...paid,...unpaid].join(', ');}else if(unpaid.length){td.classList.add('cell-unpaid');td.title=unpaid.join(', ');}tr.appendChild(td);});
    calendarTBody.appendChild(tr);
  });
  document.querySelectorAll('#calendarTable thead th.month').forEach((th,i)=>th.onclick=()=>openMonthModal(i));
}

/* ---------- Modale mensuelle ---------- */
const monthModal=document.getElementById('monthModal'),monthTitle=document.getElementById('monthModalTitle'),
      monthHead=document.querySelector('#monthTable thead'),monthBody=document.querySelector('#monthTable tbody');
function openMonthModal(idx){const per=yearSelect.value,sy=periodStartYear(per),m=idxToMonth(idx),yr=m>=5?sy:sy+1,names=['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];monthTitle.textContent=`${names[m]} ${yr}`;const tot=daysInMonth(yr,m);monthHead.innerHTML='<tr><th>Salarié·e</th>'+[...Array(tot)].map((_,d)=>`<th class="day">${d+1}</th>`).join('')+'</tr>';monthBody.innerHTML='';
  activeEmployees(per).sort((a,b)=>a.name.localeCompare(b.name)).forEach(emp=>{
    ensureRecord(per,emp.id);const rec=store.records[per][emp.id],
          paid=new Set(rec.days.filter(d=>{const dt=new Date(d);return dt.getFullYear()===yr&&dt.getMonth()===m;})),
          unpaid=new Set(rec.unpaid.filter(d=>{const dt=new Date(d);return dt.getFullYear()===yr&&dt.getMonth()===m;}));
    let row=`<td>${emp.name}</td>`;for(let d=1;d<=tot;d++){const ds=`${yr}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;row+=paid.has(ds)?`<td class="${isHoliday(ds)?'absent-holiday':'absent-day'}" title="Payé">C</td>`:unpaid.has(ds)?`<td class="unpaid-day" title="Sans solde">S</td>`:'<td></td>'; }
    const tr=document.createElement('tr');tr.innerHTML=row;monthBody.appendChild(tr);
  });
  monthModal.classList.add('show');monthModal.setAttribute('aria-hidden','false');
}
document.getElementById('closeMonthBtn').onclick=()=>{monthModal.classList.remove('show');monthModal.setAttribute('aria-hidden','true');};

/* ---------- Modale congés individuels ---------- */
const manageModal=document.getElementById('manageModal'),modalTitle=document.getElementById('modalTitle'),
      daysList=document.getElementById('daysList'),unpaidCb=document.getElementById('unpaidCheckbox');
let curId=null;
function openModal(id){curId=id;modalTitle.textContent=`Gérer les congés – ${employeeName(id)}`;initWheels();unpaidCb.checked=false;renderList();manageModal.classList.add('show');manageModal.setAttribute('aria-hidden','false');}
document.getElementById('closeModalBtn').onclick=()=>manageModal.classList.remove('show');

function renderList(){
  const per=yearSelect.value;ensureRecord(per,curId);const rec=store.records[per][curId];
  daysList.innerHTML='';
  [...rec.days.map(d=>({d,t:'payé'})),...rec.unpaid.map(d=>({d,t:'sans solde'}))]
    .sort((a,b)=>a.d.localeCompare(b.d))
    .forEach(({d,t})=>{
      const li=document.createElement('li');li.textContent=`${d} (${t}${isHoliday(d)?', férié':''})`;
      const del=document.createElement('button');del.textContent='Suppr';del.className='danger';
      del.onclick=()=>{if(confirm('Supprimer ?')){rec.days=rec.days.filter(x=>x!==d);rec.unpaid=rec.unpaid.filter(x=>x!==d);saveStore();renderList();renderEmployees();renderCalendar();}};
      li.appendChild(del);daysList.appendChild(li);
    });
}

document.getElementById('addPeriodBtn').onclick=()=>{
  const s=readDate('start'),e=readDate('end');
  if(!s||!e)return alert('Choisir les dates');if(new Date(e)<new Date(s))return alert('Retour après départ');
  const per=yearSelect.value,days=validateDays(curId,per,getWorkingDays(new Date(s),new Date(e)));if(!days.length)return alert('Aucun jour valide');
  ensureRecord(per,curId);const rec=store.records[per][curId];(unpaidCb.checked?rec.unpaid:rec.days).push(...days);
  saveStore();renderList();renderEmployees();renderCalendar();
};

/* ---------- Boutons divers ---------- */
document.getElementById('addEmployeeBtn').onclick=()=>{const n=prompt('Nom du / de la salarié·e :');if(!n)return;store.employees.push({id:'e'+Date.now(),name:n,joined:periodStartYear(yearSelect.value)});saveStore();renderEmployees();renderCalendar();};
document.getElementById('exportCsvBtn').onclick=()=>{
  const per=yearSelect.value;
  let csv='Employee,Acquis,Taken_Paid,Restant,Payés,Unpaid\n';
  activeEmployees(per).forEach(emp=>{ensureRecord(per,emp.id);const rec=store.records[per][emp.id];csv+=`${emp.name},${acquired(emp.id,per)},${taken(emp.id,per)},${acquired(emp.id,per)-taken(emp.id,per)},"${rec.days.join(' ')}","${rec.unpaid.join(' ')}"\n`;});
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`conges_${per}.csv`;a.click();
};
document.getElementById('exportJsonBtn').onclick=()=>{const b=new Blob([JSON.stringify(store)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='conges_backup.json';a.click();};
document.getElementById('importJsonBtn').onclick=()=>document.getElementById('importJsonInput').click();
document.getElementById('importJsonInput').onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{localStorage.setItem(LS_KEY,r.result);location.reload();}catch{alert('JSON invalide');}};r.readAsText(f);};
document.getElementById('printBtn').onclick=()=>window.print();

/* ---------- Import Excel/CSV (v21) ---------- */
document.getElementById('importExcelBtn').onclick=()=>document.getElementById('importExcelInput').click();

document.getElementById('importExcelInput').onchange=e=>{
  const file=e.target.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=new Uint8Array(ev.target.result);
      const wb=XLSX.read(data,{type:'array',codepage:1252});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1});
      if(!rows.length) return alert('Feuille vide');

      const header=rows[0].map(h=>h.toString().trim());
      const col={
        emp  : header.findIndex(h=>/^(Employee|Intervenant|Salari[ée])/i.test(h)),
        start: header.findIndex(h=>/^(StartDate|Départ)/i.test(h)),
        end  : header.findIndex(h=>/^(EndDate|Date de fin)/i.test(h)),
        type : header.findIndex(h=>/^(Type|Motif)/i.test(h))
      };
      if(Object.values(col).some(v=>v===-1)) return alert('Colonnes manquantes');

      const period=yearSelect.value;

      const parseDate = fr => {
        const [d,m,y]=fr.trim().split(' ')[0].split('/');
        return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
      };
      const normName = n=>{
        n=n.toString().trim();
        if(n.includes(',')){const [last,first]=n.split(',');return `${first.trim()} ${last.trim()}`.replace(/\s+/g,' ');}
        return n;
      };

      rows.slice(1).forEach(r=>{
        if(!r.length) return;
        const empName=normName(r[col.emp]||'');
        const start=parseDate(String(r[col.start]||''));
        const end=parseDate(String(r[col.end]||''));
        const raw=(r[col.type]||'').toString().toLowerCase();
        const isUnpaid=/sans solde|unpaid/.test(raw);
        if(!empName||!start||!end) return;

        let emp=store.employees.find(e=>e.name===empName);
        if(!emp){
          emp={id:'e'+Date.now()+Math.random(),name:empName,joined:periodStartYear(period)};
          store.employees.push(emp);
        }
        ensureRecord(period,emp.id);
        const days=validateDays(emp.id,period,getWorkingDays(new Date(start),new Date(end)));
        if(!days.length) return;
        const rec=store.records[period][emp.id];
        (isUnpaid?rec.unpaid:rec.days).push(...days);
      });

      saveStore();
      renderEmployees();
      renderCalendar();
      alert('Import terminé !');
    }catch(err){console.error(err);alert('Erreur lors de l’import');}
  };
  reader.readAsArrayBuffer(file);
};

/* ---------- Init ---------- */
if(!store.employees.length) store.employees=[{id:'e1',name:'Alice Dupont',joined:2025}];
renderEmployees();renderCalendar();
</script>
</body>
</html>
