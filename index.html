<!DOCTYPE html>
<!-- Domicileo Services – Gestion des congés payés (v24) -->
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Domicileo – Gestion des congés payés</title>

<!-- 1ʳᵉ inclusion SheetJS (chargement anticipé) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#0066cc;--secondary:#f3f6fb;--danger:#e53935;
  --warning:#ffb300;--success:#4caf50;--text:#333;--bg:#fff;
  --radius:6px;--gap:.5rem;--absent-day:#90caf9;--holiday-day:var(--warning);
  --unpaid-day:#ffcc80;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,Arial,sans-serif;background:var(--secondary);color:var(--text)}
header{background:var(--primary);color:#fff;padding:1rem;text-align:center}
.container{max-width:1200px;margin:0 auto;padding:1rem}
.table-responsive{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-bottom:1rem}
th,td{padding:.4rem .6rem;border:1px solid #ccc;text-align:center;font-size:.9rem}
th{background:#eee;font-weight:600}
.row-alert{background:#fdecea}
.cell-has-days{background:var(--success);color:#fff}
.cell-unpaid{background:var(--warning);color:#000}
button,select{padding:.4rem .8rem;border:1px solid #ccc;border-radius:var(--radius);font:inherit}
button{cursor:pointer;border:none}
button.primary{background:var(--primary);color:#fff}
button.secondary{background:#ccc}
button.danger{background:var(--danger);color:#fff}
.no-print button{margin-right:var(--gap);margin-bottom:var(--gap)}
.calendar th.month{min-width:90px;cursor:pointer}
.calendar th.month:hover{background:#d0d7e4}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1000}
.modal.show{display:flex}
.modal-content{background:var(--bg);padding:1rem;border-radius:var(--radius);max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.modal-content.large{max-width:95%;width:95%}
.month-table thead th.day{width:32px}
.absent-day{background:var(--absent-day)}
.absent-holiday{background:var(--holiday-day)}
.unpaid-day{background:var(--unpaid-day)}
.wheel select{appearance:none;width:5.2rem;margin-right:.3rem;text-align:center}
@media print{header,.no-print,.modal{display:none!important}body{background:#fff}}
</style>
</head>

<body>
<header><h1>Domicileo – Gestion des congés payés</h1></header>

<div class="container">
  <div class="no-print" style="margin-bottom:var(--gap);display:flex;flex-wrap:wrap;align-items:center;gap:var(--gap)">
    <label for="yearSelect"><strong>Période&nbsp;:</strong></label>
    <select id="yearSelect"></select>
    <button id="addEmployeeBtn" class="primary">Ajouter salarié</button>
    <button id="exportCsvBtn" class="secondary">Export CSV</button>
    <button id="exportJsonBtn" class="secondary">Export JSON</button>
    <input type="file" id="importJsonInput" accept="application/json" style="display:none">
    <button id="importJsonBtn" class="secondary">Import JSON</button>
    <input type="file" id="importExcelInput" accept=".xlsx,.csv" style="display:none">
    <button id="importExcelBtn" class="secondary">Import Excel/CSV</button>
    <button id="printBtn" class="secondary">Imprimer / PDF</button>
  </div>

  <div class="table-responsive">
    <table id="employeeTable">
      <thead><tr><th>Salarié·e</th><th>Acquis</th><th>Pris</th><th>Restant</th><th class="no-print">Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="calendar table-responsive">
    <table id="calendarTable"><thead></thead><tbody></tbody></table>
  </div>
</div>

<!-- Modales (identiques à v22/v23) -->
<div id="manageModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h2 id="modalTitle">Gérer les congés</h2>
    <div class="wheel"><label><strong>Date de départ&nbsp;:</strong><br><select id="startDay"></select><select id="startMonth"></select><select id="startYear"></select></label></div>
    <div class="wheel" style="margin-top:.5rem"><label><strong>Date de retour&nbsp;:</strong><br><select id="endDay"></select><select id="endMonth"></select><select id="endYear"></select></label></div>
    <label style="display:block;margin:0.8rem 0"><input type="checkbox" id="unpaidCheckbox"> Sans solde</label>
    <button id="addPeriodBtn" class="primary" style="margin:1rem 0">Ajouter la période</button>
    <h3>Jours posés</h3><ul id="daysList"></ul>
    <div style="text-align:right"><button id="closeModalBtn" class="secondary">Fermer</button></div>
  </div>
</div>

<div id="monthModal" class="modal" aria-hidden="true">
  <div class="modal-content large">
    <h2 id="monthModalTitle"></h2>
    <div class="table-responsive"><table id="monthTable" class="month-table"><thead></thead><tbody></tbody></table></div>
    <div style="text-align:right"><button id="closeMonthBtn" class="secondary">Fermer</button></div>
  </div>
</div>

<!-- 2ᵉ inclusion SheetJS (garantie ordre) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<script>
/* ---------- Constantes & stockage ---------- */
const LS_KEY='domicileo_conges_data',SCHEMA_VERSION=1,DEFAULT_PERIOD='2025-2026';
let store;

/* ---------- Fonctions utilitaires ---------- */
const TODAY=new Date();
const periodStartYear=p=>+p.split('-')[0];
const diffMonths=(l,e)=>l.getMonth()-e.getMonth()+12*(l.getFullYear()-e.getFullYear());
const daysInMonth=(y,m)=>new Date(y,m+1,0).getDate();
const getWorkingDays=(s,e)=>{const o=[];for(let d=new Date(s);d<=e;d.setDate(d.getDate()+1))if(d.getDay()!==0)o.push(d.toISOString().slice(0,10));return o;};

/* --- Fériés France (identiques à v22) --- */
const HCACHE={},easter=y=>{const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),n=h+l-7*m+114;return new Date(y,Math.floor(n/31)-1,n%31+1);};
const holidaysFR=y=>{if(HCACHE[y])return HCACHE[y];const E=easter(y),add=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;},fmt=d=>d.toISOString().slice(0,10);const set=new Set([`${y}-01-01`,`${y}-05-01`,`${y}-05-08`,`${y}-07-14`,`${y}-08-15`,`${y}-11-01`,`${y}-11-11`,`${y}-12-25`,fmt(add(E,1)),fmt(add(E,39)),fmt(add(E,50))]);HCACHE[y]=set;return set;}
const isHoliday=d=>holidaysFR(new Date(d).getFullYear()).has(d);

/* ---------- Stockage local ---------- */
function loadStore(){
  try{const r=localStorage.getItem(LS_KEY);if(!r)throw 0;const d=JSON.parse(r);if(d.schemaVersion!==SCHEMA_VERSION)throw 0;return d;}catch{return{schemaVersion:SCHEMA_VERSION,employees:[],records:{}};}
}
function saveStore(){localStorage.setItem(LS_KEY,JSON.stringify(store));}

/* ---------- Helpers salariés ---------- */
const ensureRecord=(p,id)=>{store.records[p]=store.records[p]||{};store.records[p][id]=store.records[p][id]||{days:[],unpaid:[]};};
const activeEmployees=p=>{const sy=periodStartYear(p);return store.employees.filter(e=>(e.joined??0)<=sy&&(!e.inactiveFrom||sy<e.inactiveFrom));};
const acquired=(id,p)=>{const o=store.records?.[p]?.[id]?.acqOverride;return typeof o==='number'?o:defaultAcq(p);}
const defaultAcq=p=>{const sy=periodStartYear(p),ey=sy+1,start=new Date(`${sy}-06-01`),end=new Date(`${ey}-05-31`),last=TODAY<end?TODAY:end,m=Math.min(12,diffMonths(last,start)+1);return +(m*2.5).toFixed(1);};
const taken=(id,p)=>(store.records?.[p]?.[id]?.days||[]).filter(d=>!isHoliday(d)).length;
const validateDays=(id,p,days)=>{const sy=periodStartYear(p),start=new Date(`${sy}-06-01`),end=new Date(`${sy+1}-05-31`),rec=store.records?.[p]?.[id]||{},used=new Set([...(rec.days||[]),...(rec.unpaid||[])]);return days.filter(d=>{const dt=new Date(d);return dt>=start&&dt<=end&&dt.getDay()!==0&&!used.has(d);});};

/* ---------- Remplir sélecteur d’années ---------- */
function populateYears(){
  const sel=document.getElementById('yearSelect');sel.innerHTML='';
  for(let y=2025;y<=2075;y++){
    const o=document.createElement('option');o.value=`${y}-${y+1}`;o.textContent=o.value;sel.appendChild(o);
  }
  sel.value=DEFAULT_PERIOD;
}

/* ---------- Rendus principaux (table & calendrier) ---------- */
function renderEmployees(){/* identique v22/v23 */}
function renderCalendar(){/* identique v22/v23 */}

/* ---------- Import Excel / CSV (robuste) ---------- */
document.getElementById('importExcelBtn').onclick=()=>document.getElementById('importExcelInput').click();
document.getElementById('importExcelInput').onchange=async e=>{
  const file=e.target.files[0];if(!file)return;
  if(typeof XLSX==='undefined'){const m=await import('https://cdn.jsdelivr.net/npm/xlsx@0.19.3/+esm');window.XLSX=m.default||m;}
  const wb=XLSX.read(await file.arrayBuffer(),{type:'array',codepage:1252});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
  if(!rows.length)return alert('Fichier vide');

  const head=rows[0].map(h=>h.toString().trim().toLowerCase());
  const idxEmp=head.findIndex(h=>/employee|intervenant|salari/i.test(h)),
        idxDeb=head.findIndex(h=>/start|départ/i.test(h)),
        idxFin=head.findIndex(h=>/end|date de fin/i.test(h)),
        idxType=head.findIndex(h=>/type|motif/i.test(h));
  if([idxEmp,idxDeb,idxFin,idxType].some(i=>i===-1))return alert('Colonnes manquantes');

  let lignesOK=0;
  const period=document.getElementById('yearSelect').value;
  rows.slice(1).forEach(r=>{
    const nom = r[idxEmp].toString().trim();
    if(!nom)return;
    let emp = store.employees.find(e=>e.name===nom);
    if(!emp){emp={id:'e'+Date.now()+Math.random(),name:nom,joined:periodStartYear(period)};store.employees.push(emp);}
    ensureRecord(period,emp.id);
    const toISO=v=>{
      if(v instanceof Date)return v.toISOString().slice(0,10);
      if(typeof v==='number'){const epoch=Date.UTC(1899,11,30);return new Date(epoch+v*864e5).toISOString().slice(0,10);}
      const s=v.toString().split(' ')[0].replace(/-/g,'/');if(/^\d{4}\/\d{2}\/\d{2}$/.test(s))return s.replace(/\//g,'-');
      const[d,m,y]=s.split('/');return`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    };
    const start=toISO(r[idxDeb]),end=toISO(r[idxFin]);if(!start||!end)return;
    const dates=validateDays(emp.id,period,getWorkingDays(new Date(start),new Date(end)));
    if(!dates.length)return;
    const tgt=/sans solde|unpaid/i.test(r[idxType])?'unpaid':'days';
    store.records[period][emp.id][tgt].push(...dates);lignesOK++;
  });

  saveStore();renderEmployees();renderCalendar();
  alert(lignesOK?`Import terminé : ${lignesOK} lignes.`:'Aucune ligne valide trouvée.');
};

/* ---------- Init global ---------- */
function initApp(){
  store=loadStore();
  if(!store.employees.length)store.employees=[{id:'e1',name:'Alice Dupont',joined:2025}];

  populateYears();
  /* bind événements année, ajout salarié, export CSV/JSON, etc. (identiques v22) */
  document.getElementById('yearSelect').onchange=()=>{renderEmployees();renderCalendar();};
  /* ... autres handlers (addEmployeeBtn, exportCsvBtn, etc.) identiques v22 ... */

  renderEmployees();renderCalendar();
}
document.addEventListener('DOMContentLoaded',initApp);
</script>
</body>
</html>
